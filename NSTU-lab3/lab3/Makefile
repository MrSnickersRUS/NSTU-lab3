# Makefile –¥–ª—è Lab3 - –ö–ª–∞—Å—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (C++)
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -Wpedantic -I./src -I./include
TARGET = lab3
TEST_JSON = test_json
TEST_MEMORY = test_memory
DBMS = dbms

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
MAIN_SOURCES = src/main.cpp src/commands.cpp
HEADERS = src/containers/containers.h \
          src/containers/linear.h \
          src/containers/hash.h \
          src/containers/trees.h \
          src/binary_serialization.h \
          src/commands.h \
          src/json_utils_simple.h

# –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–Ω–µ —à–∞–±–ª–æ–Ω–Ω—ã–µ)
CONTAINER_IMPL = src/containers/singlelist.cpp \
                 src/containers/doublelist.cpp \
                 src/containers/hashmap.cpp \
                 src/containers/cuckoo.cpp \
                 src/containers/set.cpp \
                 src/containers/avl.cpp

# –û–°–ù–û–í–ù–´–ï –¶–ï–õ–ò

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
all: $(TARGET)

$(TARGET): $(MAIN_SOURCES) $(HEADERS)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è $(TARGET)..."
	$(CXX) $(CXXFLAGS) -o $(TARGET) $(MAIN_SOURCES)
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
run: $(TARGET)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ $(TARGET)..."
	@echo ""
	./$(TARGET)

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫
build-run: all run

# –¢–µ—Å—Ç JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—É–¥–∞–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º Google Test –≤ tests/)

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –°–£–ë–î —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ (—Ç–µ–ø–µ—Ä—å —ç—Ç–æ main)
dbms: $(TARGET)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –°–£–ë–î..."
	@echo ""
	./$(TARGET)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å Valgrind
valgrind: $(TARGET)
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ —Å Valgrind..."
	@echo "EXIT" | valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$(TARGET)

# –ó–∞–ø—É—Å–∫ Google Test
test:
	@echo "üß™ –ó–∞–ø—É—Å–∫ Google Test..."
	@cd tests && $(MAKE) test

# –û—á–∏—Å—Ç–∫–∞ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	rm -f $(TARGET) *.json *.bin
	@cd tests && $(MAKE) clean
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
debug: CXXFLAGS += -g -DDEBUG
debug: clean $(TARGET)
	@echo "üêõ –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è –≥–æ—Ç–æ–≤–∞!"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
release: CXXFLAGS += -O3 -DNDEBUG
release: clean $(TARGET)
	@echo "‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –≥–æ—Ç–æ–≤–∞!"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –±–µ–∑ –∫–æ–º–ø–æ–Ω–æ–≤–∫–∏
check:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
	$(CXX) $(CXXFLAGS) -fsyntax-only $(MAIN_SOURCES)
	@echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω!"

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
info:
	@echo "  Lab3 - –ö–ª–∞—Å—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (C++)"
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CXX)"
	@echo "–§–ª–∞–≥–∏:      $(CXXFLAGS)"
	@echo "–¶–µ–ª—å:       $(TARGET)"
	@echo ""
	@echo "–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:"
	@echo "  ‚úì –ú–∞—Å—Å–∏–≤ (Array)"
	@echo "  ‚úì –û–¥–Ω–æ—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫ (SingleList)"
	@echo "  ‚úì –î–≤—É—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫ (DoubleList)"
	@echo "  ‚úì –°—Ç–µ–∫ (Stack)"
	@echo "  ‚úì –û—á–µ—Ä–µ–¥—å (Queue)"
	@echo "  ‚úì –•–µ—à-—Ç–∞–±–ª–∏—Ü–∞ (HashMap)"
	@echo "  ‚úì –ú–Ω–æ–∂–µ—Å—Ç–≤–æ (Set)"
	@echo "  ‚úì –ê–í–õ-–¥–µ—Ä–µ–≤–æ (AVLTree)"

# –ü–æ–º–æ—â—å
help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make           - –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"
	@echo "  make run       - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É"
	@echo "  make build-run - –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å"
	@echo "  make dbms      - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –°–£–ë–î (=run)"
	@echo "  make test      - –ó–∞–ø—É—Å—Ç–∏—Ç—å Google Test"
	@echo "  make valgrind  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ —Å Valgrind"
	@echo "  make clean     - –£–¥–∞–ª–∏—Ç—å —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo "  make debug     - –°–æ–±—Ä–∞—Ç—å —Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"
	@echo "  make release   - –°–æ–±—Ä–∞—Ç—å —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π"
	@echo "  make check     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å"
	@echo "  make info      - –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ"
	@echo "  make help      - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"

.PHONY: all run build-run dbms test valgrind clean debug release check info help
